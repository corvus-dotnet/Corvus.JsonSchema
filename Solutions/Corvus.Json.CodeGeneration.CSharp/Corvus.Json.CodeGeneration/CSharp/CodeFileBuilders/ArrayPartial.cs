// <copyright file="ArrayPartial.cs" company="Endjin Limited">
// Copyright (c) Endjin Limited. All rights reserved.
// </copyright>

using System.Text.Json;

namespace Corvus.Json.CodeGeneration.CSharp;

/// <summary>
/// Provides the Array file for a type declaration.
/// </summary>
public sealed class ArrayPartial : ICodeFileBuilder
{
    private ArrayPartial()
    {
    }

    /// <summary>
    /// Gets a singleton instance of the <see cref="ArrayPartial"/> builder.
    /// </summary>
    public static ArrayPartial Instance { get; } = new();

    /// <inheritdoc/>
    public CodeGenerator EmitFile(CodeGenerator generator, TypeDeclaration typeDeclaration)
    {
        if ((typeDeclaration.ImpliedCoreTypes() & CoreTypes.Array) != 0)
        {
            FrameworkType addExplicitUsings = typeDeclaration.AddExplicitUsings() ? FrameworkType.All : FrameworkType.NotEmitted;

            generator
                .BeginFile(typeDeclaration, "Array")
                    .AppendAutoGeneratedHeader()
                    .AppendLine()
                    .AppendLine("#nullable enable")
                    .AppendLine()
                    .AppendUsings(
                        new("global::System", addExplicitUsings),
                        new("global::System.Collections.Generic", addExplicitUsings),
                        new("global::System.IO", addExplicitUsings),
                        new("global::System.Linq", addExplicitUsings),
                        new("global::System.Net.Http", addExplicitUsings),
                        new("global::System.Threading", addExplicitUsings),
                        new("global::System.Threading.Tasks", addExplicitUsings),
                        new("System.Buffers", FrameworkType.Net80OrGreater),
                        "System.Collections",
                        "System.Collections.Immutable",
                        "System.Runtime.CompilerServices",
                        "System.Text.Json",
                        new("Corvus.Json", EmitIfNotCorvusJsonExtendedType(typeDeclaration)),
                        "Corvus.Json.Internal")
                    .AppendLine()
                    .BeginTypeDeclarationNesting(typeDeclaration)
                        .AppendDocumentation(typeDeclaration)
                        .AppendDotnet80OrGreaterCollectionBuilderAttribute(typeDeclaration)
                        .BeginPublicReadonlyPartialStructDeclaration(
                            typeDeclaration.DotnetTypeName(),
                            interfaces:
                            [
                                JsonArrayType(typeDeclaration),
                                ReadOnlyCollectionType(typeDeclaration),
                            ])
                            .AppendEmptyArrayInstanceStaticProperty(typeDeclaration)
                            .AppendArrayRankStaticProperty(typeDeclaration)
                            .AppendArrayDimensionStaticProperty(typeDeclaration)
                            .AppendArrayValueBufferSizeStaticProperty(typeDeclaration)
                            .AppendArrayIndexerProperties(typeDeclaration)
                            .AppendTupleItemProperties(typeDeclaration)
                            .AppendTupleConversions(typeDeclaration)
                            .AppendImplicitConversionFromTypeUsingConstructor(typeDeclaration, "ImmutableList<JsonAny>")
                            .AppendImplicitConversionToType(typeDeclaration, "ImmutableList<JsonAny>", "__CorvusArrayHelpers.GetImmutableList(value)")
                            .AppendImplicitConversionFromJsonValueTypeUsingConstructor(typeDeclaration, "JsonArray", JsonValueKind.Array, "value.AsImmutableList()")
                            .AppendImplicitConversionToJsonValueType(typeDeclaration, "JsonArray", CoreTypes.Array, "value.AsArray")
                            .AppendFromImmutableListOfJsonAnyFactoryMethod(typeDeclaration)
                            .AppendCreateFromSpanFactoryMethod(typeDeclaration)
                            .AppendFromItemsFactoryMethods(typeDeclaration)
                            .AppendFromRangeFactoryMethods(typeDeclaration)
                            .AppendFromSerializedItemsMethod(typeDeclaration)
                            .AppendFromValuesFactoryMethod(typeDeclaration)
                            .AppendCreateTupleFactoryMethod(typeDeclaration)
                            .AppendCollectionEnumerableMethods(typeDeclaration)
                            .AppendTryGetNumericValuesMethod(typeDeclaration)
                            .AppendAsImmutableListMethods()
                            .AppendGetArrayLengthMethod()
                            .AppendEnumerateArrayMethods(typeDeclaration)
                            .AppendArrayAddMethods(typeDeclaration)
                            .AppendArrayRemoveMethods(typeDeclaration)
                            .AppendCorvusArrayHelpers(typeDeclaration)
                        .EndClassOrStructDeclaration()
                    .EndTypeDeclarationNesting(typeDeclaration)
                    .EndNamespace()
                .EndFile(typeDeclaration, "Array");
        }

        return generator;

        static FrameworkType EmitIfNotCorvusJsonExtendedType(TypeDeclaration typeDeclaration)
        {
            return typeDeclaration.IsCorvusJsonExtendedType()
                 ? FrameworkType.NotEmitted
                 : FrameworkType.All;
        }

        static ConditionalCodeSpecification JsonArrayType(TypeDeclaration typeDeclaration)
        {
            return new(g => g.GenericTypeOf("IJsonArray", typeDeclaration));
        }

        static ConditionalCodeSpecification ReadOnlyCollectionType(TypeDeclaration typeDeclaration)
        {
            return typeDeclaration.TupleType() is null
                ? new(g => g.GenericTypeOf("IReadOnlyCollection", ArrayItemsType(typeDeclaration)))
                : ConditionalCodeSpecification.DoNotEmit;

            static TypeDeclaration ArrayItemsType(TypeDeclaration typeDeclaration)
            {
                return typeDeclaration.ArrayItemsType()?.ReducedType ?? WellKnownTypeDeclarations.JsonAny;
            }
        }
    }
}