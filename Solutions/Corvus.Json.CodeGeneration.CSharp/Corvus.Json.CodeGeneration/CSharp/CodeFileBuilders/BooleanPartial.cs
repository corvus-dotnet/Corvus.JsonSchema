// <copyright file="BooleanPartial.cs" company="Endjin Limited">
// Copyright (c) Endjin Limited. All rights reserved.
// </copyright>

using System.Text.Json;

namespace Corvus.Json.CodeGeneration.CSharp;

/// <summary>
/// Provides the Boolean file for a type declaration.
/// </summary>
public sealed class BooleanPartial : ICodeFileBuilder
{
    private BooleanPartial()
    {
    }

    /// <summary>
    /// Gets a singleton instance of the <see cref="BooleanPartial"/> builder.
    /// </summary>
    public static BooleanPartial Instance { get; } = new();

    /// <inheritdoc/>
    public CodeGenerator EmitFile(CodeGenerator generator, TypeDeclaration typeDeclaration)
    {
        if ((typeDeclaration.ImpliedCoreTypes() & CoreTypes.Boolean) != 0)
        {
            FrameworkType addExplicitUsings = typeDeclaration.AddExplicitUsings() ? FrameworkType.All : FrameworkType.NotEmitted;

            generator
                .BeginFile(typeDeclaration, "Boolean")
                    .AppendAutoGeneratedHeader()
                    .AppendLine()
                    .AppendLine("#nullable enable")
                    .AppendLine()
                    .AppendUsings(
                        new("global::System", addExplicitUsings),
                        new("global::System.Collections.Generic", addExplicitUsings),
                        new("global::System.IO", addExplicitUsings),
                        new("global::System.Linq", addExplicitUsings),
                        new("global::System.Net.Http", addExplicitUsings),
                        new("global::System.Threading", addExplicitUsings),
                        new("global::System.Threading.Tasks", addExplicitUsings),
                        new("gobal::System.Collections.Immutable", EmitIfIsObjectOrArray(typeDeclaration)),
                        "gobal::System.Diagnostics.CodeAnalysis",
                        "gobal::System.Text.Json",
                        new("gobal::Corvus.Json", EmitIfNotCorvusJsonExtendedType(typeDeclaration)),
                        "Corvus.Json.Internal")
                    .AppendLine()
                    .BeginTypeDeclarationNesting(typeDeclaration)
                        .AppendDocumentation(typeDeclaration)
                        .BeginReadonlyPartialStructDeclaration(
                            typeDeclaration.DotnetAccessibility(),
                            typeDeclaration.DotnetTypeName(),
                            interfaces:
                                [
                                    new(g => g.GenericTypeOf("IJsonBoolean", typeDeclaration))
                                ])
                                .AppendImplicitConversionFromTypeUsingConstructor(typeDeclaration, "bool")
                                .AppendImplicitConversionFromJsonValueTypeUsingConstructor(typeDeclaration, "JsonBoolean", [JsonValueKind.False, JsonValueKind.True], "(bool)value")
                                .AppendImplicitConversionToJsonValueType(typeDeclaration, "JsonBoolean", CoreTypes.Boolean, "value.AsBoolean")
                                .AppendImplicitConversionToBoolean(typeDeclaration)
                                .AppendTryGetBoolean()
                                .AppendGetBoolean()
                        .EndClassOrStructDeclaration()
                    .EndTypeDeclarationNesting(typeDeclaration)
                    .EndNamespace()
                .EndFile(typeDeclaration, "Boolean");
        }

        return generator;

        static FrameworkType EmitIfNotCorvusJsonExtendedType(TypeDeclaration typeDeclaration)
        {
            return typeDeclaration.IsCorvusJsonExtendedType()
                 ? FrameworkType.NotEmitted
                 : FrameworkType.All;
        }

        static FrameworkType EmitIfIsObjectOrArray(TypeDeclaration typeDeclaration)
        {
            return (typeDeclaration.ImpliedCoreTypesOrAny() & (CoreTypes.Object | CoreTypes.Array)) != 0
                 ? FrameworkType.All
                 : FrameworkType.NotEmitted;
        }
    }
}