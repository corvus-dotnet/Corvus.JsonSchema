// <copyright file="ObjectPartial.cs" company="Endjin Limited">
// Copyright (c) Endjin Limited. All rights reserved.
// </copyright>

using System.Text.Json;

namespace Corvus.Json.CodeGeneration.CSharp;

/// <summary>
/// Provides the Object file for a type declaration.
/// </summary>
public sealed class ObjectPartial : ICodeFileBuilder
{
    private ObjectPartial()
    {
    }

    /// <summary>
    /// Gets a singleton instance of the <see cref="ObjectPartial"/> builder.
    /// </summary>
    public static ObjectPartial Instance { get; } = new();

    /// <inheritdoc/>
    public CodeGenerator EmitFile(CodeGenerator generator, TypeDeclaration typeDeclaration)
    {
        if ((typeDeclaration.ImpliedCoreTypes() & CoreTypes.Object) != 0)
        {
            generator
                .BeginFile(typeDeclaration, "Object")
                    .AppendAutoGeneratedHeader()
                    .AppendLine()
                    .AppendLine("#nullable enable")
                    .AppendLine()
                    .AppendUsings(
                        new("System.Collections", EmitIfIsMapObject(typeDeclaration)),
                        "System.Collections.Immutable",
                        new("System.Diagnostics.CodeAnalysis", EmitIfIsMapObject(typeDeclaration)),
                        "System.Text.Json",
                        new("System.Text.RegularExpressions", EmitIfObjectHasPatternProperties(typeDeclaration)),
                        new("Corvus.Json", EmitIfNotCorvusJsonExtendedType(typeDeclaration)),
                        "Corvus.Json.Internal")
                    .AppendLine()
                    .BeginNamespace(typeDeclaration.DotnetNamespace())
                    .AppendLine()
                    .BeginTypeDeclarationNesting(typeDeclaration)
                        .AppendDocumentation(typeDeclaration)
                        .BeginPublicReadonlyPartialStructDeclaration(
                            typeDeclaration.DotnetTypeName(),
                            interfaces:
                            [
                                JsonObjectType(typeDeclaration),
                                ReadOnlyDictionaryType(typeDeclaration),
                            ])
                            .PushValidationClassNameAndScope()
                            .AppendPatternPropertiesStaticProperties(typeDeclaration)
                            .AppendImplicitConversionFromTypeUsingConstructor(typeDeclaration, "ImmutableList<JsonObjectProperty>")
                            .AppendImplicitConversionToType(typeDeclaration, "ImmutableList<JsonObjectProperty>", "__CorvusObjectHelpers.GetPropertyBacking(value)")
                            .AppendImplicitConversionFromJsonValueTypeUsingConstructor(typeDeclaration, "JsonObject", JsonValueKind.Object, "__CorvusObjectHelpers.GetPropertyBacking(value)")
                            .AppendImplicitConversionToJsonValueType(typeDeclaration, "JsonObject", CoreTypes.Object, "value.AsObject")
                            .AppendObjectIndexerProperties(typeDeclaration)
                            .AppendPropertyCount()
                            .AppendReadOnlyDictionaryProperties(typeDeclaration)
                            .PushJsonPropertyNamesClassNameAndScope()
                            .AppendPropertyAccessors(typeDeclaration)
                            .AppendFromPropertiesFactoryMethods(typeDeclaration)
                            .AppendCreateFactoryMethod(typeDeclaration)
                            .AppendAsPropertyBackingMethod()
                            .AppendEnumerateObjectMethods(typeDeclaration)
                            .AppendReadOnlyDictionaryMethods(typeDeclaration)
                            .AppendHasPropertiesMethod()
                            .AppendHasPropertyMethods()
                            .AppendTryGetPropertyMethods(typeDeclaration)
                            .AppendSetPropertyMethods(typeDeclaration)
                            .AppendRemovePropertyMethods(typeDeclaration)
                            .AppendTryGetAsDependentSchemaMethods(typeDeclaration)
                            .AppendPatternPropertiesMethods(typeDeclaration)
                            .AppendJsonPropertyNamesClass(typeDeclaration)
                            .AppendCorvusObjectHelpers(typeDeclaration)
                            .PopValidationClassNameAndScope()
                        .EndClassOrStructDeclaration()
                    .EndTypeDeclarationNesting(typeDeclaration)
                    .EndNamespace()
                .EndFile(typeDeclaration, "Object");
        }

        return generator;

        static FrameworkType EmitIfIsMapObject(TypeDeclaration typeDeclaration)
        {
            return typeDeclaration.IsMapObject()
                 ? FrameworkType.All
                 : FrameworkType.NotEmitted;
        }

        static FrameworkType EmitIfObjectHasPatternProperties(TypeDeclaration typeDeclaration)
        {
            return typeDeclaration.PatternProperties()?.Count > 0
                 ? FrameworkType.All
                 : FrameworkType.NotEmitted;
        }

        static FrameworkType EmitIfNotCorvusJsonExtendedType(TypeDeclaration typeDeclaration)
        {
            return typeDeclaration.IsCorvusJsonExtendedType()
                 ? FrameworkType.NotEmitted
                 : FrameworkType.All;
        }

        static ConditionalCodeSpecification JsonObjectType(TypeDeclaration typeDeclaration)
        {
            return new(g => g.GenericTypeOf("IJsonObject", typeDeclaration));
        }

        static ConditionalCodeSpecification ReadOnlyDictionaryType(TypeDeclaration typeDeclaration)
        {
            return
                typeDeclaration.FallbackObjectPropertyType() is FallbackObjectPropertyType objectPropertyType &&
                !objectPropertyType.ReducedType.IsBuiltInJsonAnyType()
                ? new(g =>
                    {
                        g
                        .Append("IReadOnlyDictionary<JsonPropertyName, ")
                        .Append(objectPropertyType.ReducedType.FullyQualifiedDotnetTypeName())
                        .Append(">");
                    })
                : ConditionalCodeSpecification.DoNotEmit;
        }
    }
}